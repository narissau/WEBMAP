<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapping Migration</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.32/esri/themes/light/main.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://js.arcgis.com/4.32/"></script>
</head>

<body>
    <div id="viewDiv"></div>

    <!-- Sidebar for Layer Controls -->
    <div id="layerControls">
        <h3>Data Selection</h3>
        <h4>Basemaps</h4>
        <form id="basemapForm"></form>
        <h4>Migration Volumes (Flow Lines)</h4>
        <form id="flowlineForm"></form>
    </div>

    <script>
        require([
            "esri/config",
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer"
        ], function (esriConfig, Map, MapView, FeatureLayer) { // anonymous function

            esriConfig.apiKey = "AAPTxy8BH1VEsoebNVZXo8HurGGCFBPLWn4zHTeFKkYXC8xdZ9PlNb6vx_TERSbT8dEWpQ1tlMiIcoahwMafz_F8YVz1F2IzH2PzS8571yH_yIdjFi1pLjVeLbP1qKl9sZqpsSTSUQ-lvcs-aXX4BltylF0Z1XQ_2GX3B_aGBCu2R5TL0OZF2hIp-nuwzzZ7AJQxOxiYAJA3kmvn6SYmKLsw3vJ24gfdcA8uSEghq_BXIkU.AT1_xAwz1ItR"; // Replace with your actual API key

            // Function to create FeatureLayer with popups
            function createFeatureLayer(url, title, popupTemplate) {
                return new FeatureLayer({
                    url: url,
                    title: title,
                    outFields: ["*"],
                    popupEnabled: true,
                    popupTemplate: popupTemplate,
                    visible: false // Start hidden
                });
            }

            // Map setup
            const map = new Map({
                basemap: "dark-gray-vector",
                spatialReference: { wkid: 3857 }
            });

            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [0, 20],
                zoom: 2,
                constraints: {
                    minZoom: 1,
                    maxZoom: 10,
                    rotationEnabled: false
                }
            });

            // Country layer (Always visible)
            const countryLayer = new FeatureLayer({
                url: "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/GEOG_521_Migration_Data/FeatureServer/13",
                title: "WORLD_Origin", // Ensure a title is set
                outFields: ["*"],
                popupEnabled: true,
                popupTemplate: {
                    title: "Country",
                    content: "<p><b>Name:</b> {Origin}</p>"
                }
            });


            console.log("Country Layer:", countryLayer);
            map.add(countryLayer);
            countryLayer.when(() => console.log("Country Layer Loaded Successfully"), (error) => console.error("Country Layer Failed to Load:", error));



            // Basemap layers (Start hidden)
            const basemapLayers = [
                {
                    key: "changeInImmigrants",
                    layer: createFeatureLayer(
                        "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/GEOG_521_Migration_Data/FeatureServer/41",
                        "Net Immigration Change (2015-2020)",
                        {
                            title: "Net Immigration Change (2015-2020)",
                            content: "<p><b>Country:</b> {Name_new}</p><p><b>Change:</b> {Change_in_the_number_of_interna}</p>"
                        }
                    )
                },
                {
                    key: "changeInEmigrants",
                    layer: createFeatureLayer(
                        "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/GEOG_521_Migration_Data/FeatureServer/1",
                        "Net Emigration Change (2015-2020)",
                        {
                            title: "Net Emigration Change (2015-2020)",
                            content: "<p><b>Country:</b> {Name_new}</p><p><b>Change:</b> {Change_in_the_number_of_emigran}</p>"
                        }
                    )
                },
                {
                    key: "netMigration",
                    layer: createFeatureLayer(
                        "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/GEOG_521_Migration_Data/FeatureServer/42",
                        "Net Migration (2024)",
                        {
                            title: "Net Migration (2024)",
                            content: "<p><b>Country:</b> {name}</p><p><b>Net Migration:</b> {Net_migration___Sex__all___Age_}</p>"
                        }
                    )
                }
            ];

            // Flowline layers
            const flowlineLayers = [
                {
                    key: "flowLines1990",
                    layer: createFeatureLayer(
                        "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/GEOG_521_Migration_Data/FeatureServer/44",
                        "1990-1995",
                        {
                            title: "Migration Flow (1990-1995)",
                            content: "<p><b>Origin:</b> {Origin}</p><p><b>Destination:</b> {Destination}</p><p><b>Total Migrants:</b> {Migrants}</p>"
                        }
                    )
                },
                {
                    key: "flowLines1995",
                    layer: createFeatureLayer(
                        "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/GEOG_521_Migration_Data/FeatureServer/45",
                        "1995-2000",
                        {
                            title: "Migration Flow (1995-2000)",
                            content: "<p><b>Origin:</b> {Origin}</p><p><b>Destination:</b> {Destination}</p><p><b>Total Migrants:</b> {Migrants}</p>"
                        }
                    )
                },
                {
                    key: "flowLines2000",
                    layer: createFeatureLayer(
                        "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/GEOG_521_Migration_Data/FeatureServer/48",
                        "2000-2005",
                        {
                            title: "Migration Flow (2000-2005)",
                            content: "<p><b>Origin:</b> {Origin}</p><p><b>Destination:</b> {Destination}</p><p><b>Total Migrants:</b> {Migrants}</p>"
                        }
                    )
                },
                {
                    key: "flowLines2005",
                    layer: createFeatureLayer(
                        "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/GEOG_521_Migration_Data/FeatureServer/46",
                        "2005-2010",
                        {
                            title: "Migration Flow (2005-2010)",
                            content: "<p><b>Origin:</b> {Origin}</p><p><b>Destination:</b> {Destination}</p><p><b>Total Migrants:</b> {Migrants}</p>"
                        }
                    ),
                    default: true
                }
            ];

            [...basemapLayers, ...flowlineLayers].forEach(item => map.add(item.layer));

            // Function to add radio buttons for basemaps
            function addBasemapToggles() {
                const form = document.getElementById("basemapForm");

                // "None" radio button
                const noneRadio = document.createElement("input");
                noneRadio.type = "radio";
                noneRadio.name = "basemapGroup";
                noneRadio.id = "noneBasemap";
                noneRadio.checked = true;
                noneRadio.addEventListener("change", () => {
                    basemapLayers.forEach(layerItem => {
                        layerItem.layer.visible = false;
                    });
                });

                const noneLabel = document.createElement("label");
                noneLabel.htmlFor = "noneBasemap";
                noneLabel.innerText = "None";

                const noneDiv = document.createElement("div");
                noneDiv.className = "layer-item";
                noneDiv.appendChild(noneRadio);
                noneDiv.appendChild(noneLabel);
                form.appendChild(noneDiv);

                // Basemap radio buttons
                basemapLayers.forEach(item => {
                    const radio = document.createElement("input");
                    radio.type = "radio";
                    radio.name = "basemapGroup";
                    radio.id = item.key;
                    radio.checked = false;
                    radio.addEventListener("change", () => {
                        basemapLayers.forEach(layerItem => {
                            layerItem.layer.visible = layerItem.key === item.key;
                        });
                    });

                    const label = document.createElement("label");
                    label.htmlFor = item.key;
                    label.innerText = item.layer.title;

                    const div = document.createElement("div");
                    div.className = "layer-item";
                    div.appendChild(radio);
                    div.appendChild(label);
                    form.appendChild(div);
                });
            }

            // Function to add flowline toggles
            function addFlowlineToggles() {
                const form = document.getElementById("flowlineForm");

                flowlineLayers.forEach((item, index) => {
                    const radio = document.createElement("input");
                    radio.type = "radio";
                    radio.name = "flowlineGroup";
                    radio.id = item.key;
                    radio.checked = item.default || false; // Make 2005-2010 default
                    item.layer.visible = item.default || false;

                    radio.addEventListener("change", () => {
                        flowlineLayers.forEach(layerItem => {
                            layerItem.layer.visible = layerItem.key === item.key;
                        });
                    });

                    const label = document.createElement("label");
                    label.htmlFor = item.key;
                    label.innerText = item.layer.title;

                    const div = document.createElement("div");
                    div.className = "layer-item";
                    div.appendChild(radio);
                    div.appendChild(label);
                    form.appendChild(div);
                });
            }

            flowlineLayers.forEach(item => {
                item.layer.visible = false;
                item.layer.definitionExpression = "1=0"; // This ensures nothing is shown at startup
                map.add(item.layer);
            });

            // Click event for selecting a country and showing flow lines
            view.on("click", function (event) {
                view.hitTest(event).then(function (response) {
                    console.log("ðŸ” Full Hit Test Response:", response.results);

                    if (response.results.length === 0) {
                        console.log("âŒ Nothing clicked.");
                        return;
                    }

                    response.results.forEach((res, index) => {
                        if (res.graphic && res.graphic.layer) {
                            console.log(`ðŸ” Hit Test Result ${index + 1}:`);
                            console.log(`   - Layer Title: ${res.graphic.layer.title || "Unnamed Layer"}`);
                            console.log(`   - Layer ID: ${res.graphic.layer.id || "No ID"}`);
                            console.log(`   - Layer URL: ${res.graphic.layer.url || "No URL"}`);
                            console.log(`   - Available Attributes:`, res.graphic.attributes);
                        } else {
                            console.log("âš ï¸ Warning: No valid layer found for this graphic.");
                        }
                    });

                    console.log("â“ What is the detected layer title?");

                    // Identify the country layer based on its correct name: "WORLD_Origin"
                    const countryFeature = response.results.find(res =>
                        res.graphic && res.graphic.layer && res.graphic.layer.url.includes("FeatureServer/13")
                    );


                    if (countryFeature) {
                        let selectedCountry = countryFeature.graphic.attributes["Origin"];

                        if (selectedCountry) {
                            console.log(`ðŸŽ¯ Selected Country: ${selectedCountry}`);
                            console.log(`Applying filter: Origin = '${selectedCountry}'`);

                            flowlineLayers.forEach(layerItem => {
                                layerItem.layer.definitionExpression = `Origin = '${selectedCountry}'`;
                                layerItem.layer.visible = true;
                            });
                        } else {
                            console.log("âŒ No valid 'Origin' field found in the clicked feature.");
                            flowlineLayers.forEach(layerItem => {
                                layerItem.layer.visible = false;
                                layerItem.layer.definitionExpression = "1=0";
                            });
                        }
                    } 

                });
            });






            view.popup.autoOpenEnabled = true;

            // Populate toggle menus
            view.when(() => {
                addBasemapToggles();
                addFlowlineToggles();
            });

            view.popup.autoOpenEnabled = true;
        });
    </script>
</body>

</html>